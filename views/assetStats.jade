extends layout
block head
  link(rel="stylesheet", href="/css/nv.d3.css")

  Sale statistics for your #{network} Account
  script(src='/js/nvd3/d3.v3.js')
  script(src='/js/nvd3/nv.d3.min.js')
  script(src='/js/nvd3/utils.js')
  script(src='/js/nvd3/models/axis.js')
  script(src='/js/nvd3/tooltip.js')
  script(src='/js/nvd3/models/legend.js')
  script(src='/js/nvd3/models/axis.js')
  script(src='/js/nvd3/models/scatter.js')
  script(src='/js/nvd3/models/stackedArea.js')
  script(src='/js/nvd3/models/stackedAreaChart.js')
  script
  
    data = !{data};

    var stats = !{stats};

    var data2 = new Array();

    function fetchData() {
        for (var property in stats[0]) {
            if (property == 'dateof') {
                continue;
            }
            var row = {key: property, values: []};
            for (var i = 0; i < stats.length; ++i) {
                row.values.push([new Date(stats[i].dateof).getTime(), stats[i][property]])
            }
            data2.push(row);
        }
    }

    function convertData(data) {
        var converted = new Array();
        for (var property in data[0]) {
            if (property == 'dateof') {
                continue;
            }
            var row = {key: property, values: []};
            for (var i = 0; i < data.length; ++i) {
                row.values.push([new Date(data[i].dateof).getTime(), data[i][property]])
            }
            converted.push(row);
        }
        return converted;
    }

    var generateGraph = function() {
        var chart = nv.models.stackedAreaChart()
                        .x(function(d) { return d[0] })
                        .y(function(d) { return d[1] })
                        .clipEdge(true);

        chart.xAxis
            .showMaxMin(false)
            .tickFormat(function(d) { return d3.time.format('%x')(new Date(d)) });

        chart.yAxis
            .tickFormat(d3.format(',.2f'));

        d3.select('#chart svg')
            .datum(data2)
            .transition().duration(500).call(chart);

        nv.utils.windowResize(chart.update);

        return chart;
    }
 
    var chart;
    fetchData()
    nv.addGraph(generateGraph);

   
    redrawGraph = function(url) {
        d3.json(url, function(error, data) {
            if (error) return console.warn(error);
            data2 = convertData(data.stats);
            generateGraph();
        });
    };
    
    function addAsset(asset) {
        
    }


block body
  .title
    h1(align="center") Statistics  #{network}
    include navigator
    .container-fluid
      .row-fluid
        <div id="chart">
        <svg style="height:500px"></svg>
        </div>
        <a onclick='redrawGraph("http://localhost:3002/json/stats/assets?assets=2&assets=3&assets=4")'>refresh</p>
        <a onclick='redraw()'>refresh</p>
